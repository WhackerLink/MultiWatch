<!--
  WhackerLink - Multi Watch

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program. If not, see <http://www.gnu.org/licenses/>.

  Copyright (C) 2023-2024 Caleb, K4PHP

  Derived from: https://github.com/RiceaRaul/gta-v-map-leaflet
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map - <%= network.name %></title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .leaflet-popup-content-wrapper {
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    const center_x = 117.3;
    const center_y = 172.8;
    const scale_x = 0.02072;
    const scale_y = 0.0205;

    CUSTOM_CRS = L.extend({}, L.CRS.Simple, {
        projection: L.Projection.LonLat,
        scale: function(zoom) {
            return Math.pow(2, zoom);
        },
        zoom: function(sc) {
            return Math.log(sc) / 0.6931471805599453;
        },
        distance: function(pos1, pos2) {
            var x_difference = pos2.lng - pos1.lng;
            var y_difference = pos2.lat - pos1.lat;
            return Math.sqrt(x_difference * x_difference + y_difference * y_difference);
        },
        transformation: new L.Transformation(scale_x, center_x, -scale_y, center_y),
        infinite: true
    });

    const SatelliteStyle = L.tileLayer('/mapStyles/styleSatelite/{z}/{x}/{y}.jpg', {
        minZoom: 0,
        maxZoom: 8,
        noWrap: true,
        attribution: 'Online map GTA V',
        id: 'SatelliteStyle'
    });

    const AtlasStyle = L.tileLayer('/mapStyles/styleAtlas/{z}/{x}/{y}.jpg', {
        minZoom: 0,
        maxZoom: 5,
        noWrap: true,
        attribution: 'Online map GTA V',
        id: 'AtlasStyle'
    });

    const GridStyle = L.tileLayer('/mapStyles/styleGrid/{z}/{x}/{y}.png', {
        minZoom: 0,
        maxZoom: 5,
        noWrap: true,
        attribution: 'Online map GTA V',
        id: 'GridStyle'
    });

    var mymap = L.map('map', {
        crs: CUSTOM_CRS,
        minZoom: 1,
        maxZoom: 5,
        Zoom: 5,
        maxNativeZoom: 5,
        preferCanvas: true,
        layers: [SatelliteStyle],
        center: [0, 0],
        zoom: 3,
    });

    const layersControl = L.control.layers({
        "Satellite": SatelliteStyle,
        "Atlas": AtlasStyle,
        "Grid": GridStyle
    }).addTo(mymap);

    const ExampleGroup = L.layerGroup().addTo(mymap);

    function customIcon(icon) {
        return L.icon({
            iconUrl: `/blips/${icon}.png`,
            iconSize: [20, 20],
            iconAnchor: [10, 10],
            popupAnchor: [0, -15]
        });
    }

    const socket = io();

    socket.on('report', (data) => {
        console.log(data.Type);
        if (data.Type === 0x12) { // 0x12 = emerg alarm req
            L.marker([Number(data.Long), Number(data.Lat)], { icon: customIcon('1') })
                .addTo(ExampleGroup)
                .bindPopup(`
                    Src ID: ${data.SrcId}<br>
                    TGID ID: ${data.DstId}
                `);
        }
    });
</script>
</body>
</html>
